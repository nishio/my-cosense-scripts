function fetchAllPageData(e,t){const n=`https://scrapbox.io/api/pages/${e}/${encodeURIComponent(t)}`;return fetch(n).then((e=>e.json()))}async function fetchPage({projectName:e,title:t}){const n=`https://scrapbox.io/api/pages/${e}/${encodeURIComponent(t)}/text`,o=await fetch(n);if(o.ok){return"## "+t+"\n"+await o.text()}return""}function ensureDialogExists(){let e=document.getElementById("resultDialog");if(!e){e=document.createElement("dialog"),e.id="resultDialog";const t=document.createElement("label"),n=document.createElement("input");n.type="checkbox",n.id="cbCurrent",n.checked=!0,t.appendChild(n),t.appendChild(document.createTextNode("current")),e.appendChild(t),e.appendChild(document.createTextNode(" "));const o=document.createElement("label"),c=document.createElement("input");c.type="checkbox",c.id="cb1hop",c.checked=!0,o.appendChild(c),o.appendChild(document.createTextNode("1hop")),e.appendChild(o),e.appendChild(document.createTextNode(" "));const a=document.createElement("label"),i=document.createElement("input");i.type="checkbox",i.id="cb2hop",i.checked=!0,a.appendChild(i),a.appendChild(document.createTextNode("2hop")),e.appendChild(a),e.appendChild(document.createTextNode(" "));const r=document.createElement("label"),d=document.createElement("input");d.type="checkbox",d.id="cbProj",d.checked=!0,r.appendChild(d),r.appendChild(document.createTextNode("proj")),e.appendChild(r),e.appendChild(document.createElement("br"));const p=document.createElement("textarea");p.id="resultTextarea",p.style.width="600px",p.style.height="400px",e.appendChild(p),e.appendChild(document.createElement("br"));const l=document.createElement("button");l.id="closeBtn",l.textContent="閉じる",l.addEventListener("click",(()=>e.close())),e.appendChild(l),document.body.appendChild(e)}return e}console.log("[concat-pages] Loaded concat-pages.user.js script");let links1hop=[],links2hop=[],projLinks=[],cache=null,initDone=!1;async function initAndShowDialog(){if(!initDone){const e=scrapbox.Project.name,t=(await fetchAllPageData(e,scrapbox.Page.title)).relatedPages;links1hop=t.links1hop.map((({title:t})=>({projectName:e,title:t}))),links2hop=t.links2hop.map((({title:t})=>({projectName:e,title:t}))),projLinks=t.projectLinks1hop.map((({projectName:e,title:t})=>({projectName:e,title:t}))),cache={links1hop:{},links2hop:{},projLinks:{}};const n=await fetchPage({projectName:e,title:scrapbox.Page.title});cache.currentPage=n,ensureDialogExists(),document.getElementById("cb1hop").addEventListener("change",updateTextareaContent),document.getElementById("cb2hop").addEventListener("change",updateTextareaContent),document.getElementById("cbProj").addEventListener("change",updateTextareaContent),initDone=!0}updateTextareaContent(),ensureDialogExists().showModal()}function updateTextareaContent(){const e=document.getElementById("cb1hop").checked,t=document.getElementById("cb2hop").checked,n=document.getElementById("cbProj").checked,o=document.getElementById("cbCurrent").checked,c=[];e&&c.push(...Object.values(cache.links1hop)),t&&c.push(...Object.values(cache.links2hop)),n&&c.push(...Object.values(cache.projLinks)),o&&cache.currentPage&&c.push(cache.currentPage);const a=c.join("\n\n");document.getElementById("resultTextarea").value=a,navigator.clipboard.writeText(a).catch((e=>console.error("Clipboard error: ",e)))}console.log("[concat-pages] About to add menu"),scrapbox.PageMenu.addItem({title:"concatPages",onClick:()=>initAndShowDialog()}),function(){"use strict";scrapbox.PopupMenu.addButton({title:"Convert Markdown",onClick:e=>{const t=function convertToScrapbox(e){const t=e.split("\n");let n=[],o=0;return t.forEach((e=>{const t=e.trimStart(),c=(e.length-t.length)/2;c>o?o++:c<o&&o--,e.startsWith("## ")?e="[*** "+e.slice(3).replace("**","")+"]":e.startsWith("### ")?e="[** "+e.slice(4).replace("**","")+"]":e.startsWith("#### ")&&(e="[** "+e.slice(5).replace("**","")+"]");const a=(e=e.replace(/\*\*(.*?)\*\*/g,"[* $1]")).trimStart().replace(/^-/,""),i=a?" ".repeat(o)+a:"";n.push(i)})),n.join("\n")}(e);return navigator.clipboard.writeText(t).then((()=>{alert("Converted text copied to clipboard!")})),t}})}(),function(){"use strict";scrapbox.PageMenu.addMenu({title:"Porter",image:"https://gyazo.com/d4c84afa1b488a1b4766ae6aa1295a9f/raw",onClick:()=>{location.href=location.href.replace("https","sbporter")}})}(),function(){"use strict";scrapbox.PopupMenu.addButton({title:"🍅",onClick:e=>{const timeFormat=e=>`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`,t=new Date,n=new Date(t.getTime()+15e5);return`[nishio.icon]🍅${timeFormat(t)}-${timeFormat(n)}["${e}"]`}})}(),function(){"use strict";scrapbox.PopupMenu.addButton({title:"ToMyProj",onClick:e=>{const t=scrapbox.Project.name,n=e.replace(/\[([^\]\/]+).icon\]/gm,`[/${t}/$1.icon]`).split(/[\r\n]/g),o=scrapbox.Page.title;n.unshift(`from[/${t}/${o}]`);const c=encodeURIComponent(o),a=n.join("\n");navigator.clipboard.writeText(a).then((()=>{if(window.confirm("copied.createpage?")){const e=encodeURIComponent(a);window.open(`https://scrapbox.io/nishio/Re:${c}?body=${e}`)}}))}})}();